<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wohnungen Am Zug</title>
  <style>
    :root{ --panel:#f1f3f5; --line:#cfd7dd; --head:#d2bd76; --text:#233441 }
    body{margin:0;font-family:sans-serif;background:#fff;color:var(--text)}
    .wrap{max-width:1400px;margin:22px auto;padding:12px}
    .panel{background:var(--panel);border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.08);padding:18px 22px}
    .controls{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
    .field label{display:block;font-size:12px;color:#6b7b86;margin-bottom:4px}
    select{width:100%;padding:6px 8px;border-radius:6px;border:1px solid var(--line)}
    .grid{display:grid;grid-template-columns:1fr 2fr;gap:18px;align-items:start}
    .table-col{min-width:0}
    .visual-col{min-width:0}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
    thead{background:var(--head);color:#000}
    th,td{padding:8px 10px;font-size:14px;border-bottom:1px solid #e0e6eb;text-align:left}
    tr:hover, tr.active{background:#f8fbfd}
    .map-container{background:#fff;border-radius:12px;border:1px solid #dfe6eb;padding:10px;display:flex;align-items:center;justify-content:center;height:100%}
    svg{width:100%;height:100%}
    .legend{display:flex;gap:14px;justify-content:flex-end;margin-top:10px;font-size:13px;color:#6b7b86}
    .legend .sq{width:12px;height:12px;border-radius:2px}
    .sq.ok{background:#5BBE7C}.sq.warn{background:#F5B942}.sq.no{background:#E17575}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%}
    .dot.available{background:#5BBE7C}
    .dot.reserved{background:#F5B942}
    .dot.rented{background:#E17575}

    .unit-block{transition:filter .18s ease, transform .18s ease; cursor:pointer}
    .unit-block.highlight{filter:saturate(1.8) brightness(1.06); transform:translateY(-2px)}
    .row-highlight{background:#fff7d6 !important; box-shadow:inset 0 0 0 2px #f5b94240}
    .row-flash{animation:flash 1.2s ease}
    @keyframes flash{0%{background:#fff3c4} 100%{background:transparent}}

    /* Keep outlines on balconies */
    .balcony polygon{stroke:rgba(0,0,0,0.1); stroke-width:2}
    .balcony.highlight polygon{filter:saturate(1.8) brightness(1.06)}

    /* Mobile first: visual first, big */
    @media (max-width: 900px){
      .grid{display:flex;flex-direction:column}
      .visual-col{order:-1}
      .map-container{height:65vh}
      .controls{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <h1>Wohnungen Am Zug</h1>

    <div class="controls">
      <div class="field"><label>Etage</label><select id="floorSel"></select></div>
      <div class="field"><label>Status</label><select id="statusSel">
        <option value="all">Alle</option>
        <option value="available">Verfügbar</option>
        <option value="reserved">Reserviert</option>
        <option value="rented">Vermietet</option>
      </select></div>
      <div class="field"><label>Zimmer</label><select id="roomsSel"></select></div>
    </div>

    <div class="grid">
      <div class="table-col">
        <table>
          <thead>
            <tr>
              <th>Nr.</th>
              <th>Zimmer</th>
              <th>Etage</th>
              <th>m²</th>
              <th>Status</th>
              <th>Factsheet</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="visual-col">
        <div class="map-container">
          <svg id="buildingSvg" viewBox="0 0 1600 900"></svg>
        </div>
        <div class="legend"><span class="sq ok"></span> Verfügbar <span class="sq warn"></span> Reserviert <span class="sq no"></span> Vermietet</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== 1) BASE DATA (fallback) ===== */
const DATA=[];
for(let i=1;i<=7;i++){DATA.push({id:`1.${i}`,rooms:2.5,level:1,m2:56,status:(i%3===0?"reserved":"available")});}
for(let i=1;i<=14;i++){DATA.push({id:`2.${i}`,rooms:1.5,level:2,m2:32.3,status:(i%5===0?"rented":"available")});}
for(let i=1;i<=3;i++){DATA.push({id:`3.${i}`,rooms:2.5,level:3,m2:56,status:"available"});}

/* Factsheet fallback by room type */
const DEFAULT_FACTSHEET = {
  "2.5": "https://am-zug.ch/wp-content/uploads/2024/11/2.5-zimmer-wohnung-1.pdf",
  "1.5": "https://am-zug.ch/wp-content/uploads/2024/11/1.5-zimmer-wohnung.pdf"
};

/* ===== 2) GOOGLE SHEET SYNC (with SAFE normalizers) ===== */
const STATUS_CSV = "https://docs.google.com/spreadsheets/d/1-oeqRNM-CxGaILY7FNWaNMgC9ccBWDZDwU5l0Eic0pk/export?format=csv&gid=0";

function normalizeId(raw){
  let s = String(raw||"").trim();
  if(!/^\d+\.\d+$/.test(s)) return s;
  let [fl, frac] = s.split(".");
  if(fl==="1"||fl==="3"){
    while(frac.length>1 && frac.endsWith("0")) frac = frac.slice(0,-1);
    return `${fl}.${frac}`;
  }
  return `${fl}.${frac}`;
}
function normalizeStatus(raw){
  const t = String(raw||"").trim().toLowerCase();
  if(['available','verfügbar','verfuegbar','frei'].includes(t)) return 'available';
  if(['reserved','reserviert'].includes(t)) return 'reserved';
  if(['rented','vermietet','belegt'].includes(t)) return 'rented';
  return 'available'; // safe default
}
function parseStatusCsv(text){
  const lines = text.trim().split(/\r?\n/);
  if(!lines.length) return [];
  const headers = lines[0].split(",").map(h=>h.trim().toLowerCase());
  const rows = lines.slice(1).filter(Boolean);
  return rows.map(r=>{
    const vals=r.split(",").map(s=>(s||"").trim());
    const obj={}; headers.forEach((h,i)=>obj[h]=vals[i]||"");
    return { id: normalizeId(obj.id), status: normalizeStatus(obj.status), factsheet:obj.factsheet||"" };
  });
}
async function syncStatusesFromSheet(){
  try{
    const url = STATUS_CSV + "&_cb=" + Date.now();
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error("CSV fetch failed: " + res.status);
    const txt = await res.text();
    const rows = parseStatusCsv(txt);

    const byId = new Map(DATA.map(d=>[d.id,d]));
    rows.forEach(({id,status,factsheet})=>{
      const unit = byId.get(id);
      if(unit){
        unit.status = normalizeStatus(status);
        unit.factsheet = factsheet || DEFAULT_FACTSHEET[String(unit.rooms)];
      }
    });
    DATA.forEach(u=>{ 
      u.status = normalizeStatus(u.status);
      if(!u.factsheet) u.factsheet = DEFAULT_FACTSHEET[String(u.rooms)] || ""; 
    });

    applyFilters();
    buildSvg();
    setSvgInteractivity();
  }catch(e){
    console.warn("Status sync failed:", e);
  }
}

/* ===== 3) COLORS & SAFETY ===== */
const statusColors={
  available:{top:'#dff2e7',front:'#cce6d6',side:'#c2dfcf'},
  reserved:{top:'#fff3db',front:'#f0e1bf',side:'#e8d7ad'},
  rented:{top:'#f9e0e0',front:'#eac9c9',side:'#e2bcbc'}
};
function safeColors(status){
  return statusColors[normalizeStatus(status)] || statusColors.available;
}
/* special fills */
const FILL_DARK15 = 'rgba(0,0,0,0.15)';
const STAIRS_FILL = 'url(#stairsPattern)';

/* ===== 4) TABLE & FILTERS ===== */
function renderTable(list){
  const tbody=document.getElementById('tbody');
  tbody.innerHTML=list.map(d=>`
    <tr data-unit="${d.id}">
      <td>${d.id}</td>
      <td>${d.rooms}</td>
      <td>${d.level}</td>
      <td>${d.m2}</td>
      <td><span class='dot ${normalizeStatus(d.status)}' title='${normalizeStatus(d.status)}'></span></td>
      <td>${d.factsheet ? `<a href="${d.factsheet}" target="_blank" rel="noopener">Factsheet</a>` : '–'}</td>
    </tr>`).join('');

  tbody.querySelectorAll('tr').forEach(tr=>{
    const id=tr.getAttribute('data-unit');
    tr.addEventListener('mouseenter',()=>highlight(id,true));
    tr.addEventListener('mouseleave',()=>highlight(id,false));
    tr.addEventListener('click',()=>openFactsheet(id));
  });
}
function applyFilters(){
  const fFloor=document.getElementById('floorSel').value;
  const fStatus=normalizeStatus(document.getElementById('statusSel').value);
  const fRooms=document.getElementById('roomsSel').value;
  const list=DATA.filter(d=>(fFloor==='all'||d.level==fFloor)
    && (fStatus==='all'||normalizeStatus(d.status)===fStatus)
    && (fRooms==='all'||d.rooms==fRooms));
  renderTable(list);
}
/* Dropdowns */
const floorSel=document.getElementById('floorSel');
const roomsSel=document.getElementById('roomsSel');
const floors=[...new Set(DATA.map(d=>d.level))];
const rooms=[...new Set(DATA.map(d=>d.rooms))];
floorSel.innerHTML='<option value="all">Alle</option>'+floors.map(f=>`<option value="${f}">${f}</option>`).join('');
roomsSel.innerHTML='<option value="all">Alle</option>'+rooms.map(r=>`<option value="${r}">${r}</option>`).join('');

/* ===== 5) ISOMETRIC PROJECTION ===== */
const COS=Math.cos(Math.PI/6);
const SIN=Math.sin(Math.PI/6);
function isoX(x,y,z){return (x + y)*COS;}
function isoY(x,y,z){return (y - x)*SIN - z;}

function makeIsoBlock(x,y,z,w,d,h,colors,unitId){
  const g=document.createElementNS('http://www.w3.org/2000/svg','g');
  g.setAttribute('class','unit-block');
  if(unitId) g.setAttribute('data-unit',unitId);
  const top=`${isoX(x,y,z)} ${isoY(x,y,z)} ${isoX(x+w,y,z)} ${isoY(x+w,y,z)} ${isoX(x+w,y+d,z)} ${isoY(x+w,y+d,z)} ${isoX(x,y+d,z)} ${isoY(x,y+d,z)}`;
  const pTop=document.createElementNS('http://www.w3.org/2000/svg','polygon'); pTop.setAttribute('points',top); pTop.setAttribute('fill',colors.top);
  const front=`${isoX(x,y,z)} ${isoY(x,y,z)} ${isoX(x+w,y,z)} ${isoY(x+w,y,z)} ${isoX(x+w,y,z+h)} ${isoY(x+w,y,z+h)} ${isoX(x,y,z+h)} ${isoY(x,y,z+h)}`;
  const pFront=document.createElementNS('http://www.w3.org/2000/svg','polygon'); pFront.setAttribute('points',front); pFront.setAttribute('fill',colors.front);
  const side=`${isoX(x+w,y,z)} ${isoY(x+w,y,z)} ${isoX(x+w,y+d,z)} ${isoY(x+w,y+d,z)} ${isoX(x+w,y+d,z+h)} ${isoY(x+w,y+d,z+h)} ${isoX(x+w,y,z+h)} ${isoY(x+w,y,z+h)}`;
  const pSide=document.createElementNS('http://www.w3.org/2000/svg','polygon'); pSide.setAttribute('points',side); pSide.setAttribute('fill',colors.side);
  g.appendChild(pTop); g.appendChild(pFront); g.appendChild(pSide);
  return g;
}
function makeIsoPrismRaw(x,y,z,w,d,h,colors, cssClass, unitId){
  const g=document.createElementNS('http://www.w3.org/2000/svg','g');
  if(cssClass) g.setAttribute('class',cssClass);
  if(unitId) g.setAttribute('data-unit',unitId);
  const topPts=`${isoX(x,y,z)} ${isoY(x,y,z)} ${isoX(x+w,y,z)} ${isoY(x+w,y,z)} ${isoX(x+w,y+d,z)} ${isoY(x+w,y+d,z)} ${isoX(x,y+d,z)} ${isoY(x,y+d,z)}`;
  const fPts=`${isoX(x,y,z)} ${isoY(x,y,z)} ${isoX(x+w,y,z)} ${isoY(x+w,y,z)} ${isoX(x+w,y,z+h)} ${isoY(x+w,y,z+h)} ${isoX(x,y,z+h)} ${isoY(x,y,z+h)}`;
  const sPts=`${isoX(x+w,y,z)} ${isoY(x+w,y,z)} ${isoX(x+w,y+d,z)} ${isoY(x+w,y+d,z)} ${isoX(x+w,y+d,z+h)} ${isoY(x+w,y+d,z+h)} ${isoX(x+w,y,z+h)} ${isoY(x+w,y,z+h)}`;
  const pTop=document.createElementNS('http://www.w3.org/2000/svg','polygon'); pTop.setAttribute('points',topPts);
  const pFront=document.createElementNS('http://www.w3.org/2000/svg','polygon'); pFront.setAttribute('points',fPts);
  const pSide=document.createElementNS('http://www.w3.org/2000/svg','polygon'); pSide.setAttribute('points',sPts);
  [pTop,pFront,pSide].forEach((p,i)=>{
    const key=i===0?'top':(i===1?'front':'side');
    const fill=colors[key];
    p.setAttribute('fill', (fill && fill!=='none')? fill : 'none');
  });
  g.appendChild(pTop); g.appendChild(pFront); g.appendChild(pSide);
  return g;
}

/* Full-length balconies (left=front, right=rear) */
function addFullLengthBalconies(x,y,z,w,d,status,unitId){
  const bw=35, bh=4;
  const colors=safeColors(status);
  const leftFull  = makeIsoPrismRaw(x-bw-1, y, z, bw, d, bh, colors, 'balcony', unitId); // FRONT
  const rightFull = makeIsoPrismRaw(x+w+1, y, z, bw, d, bh, colors, 'balcony', unitId); // REAR
  return [leftFull, rightFull];
}

/* Lift inset (small box on top face) */
function addInsetOnTop(g, x, y, z, w, d, insetPx, fill, stroke){
  const top = [
    [isoX(x,     y,     z), isoY(x,     y,     z)],
    [isoX(x+w,   y,     z), isoY(x+w,   y,     z)],
    [isoX(x+w,   y+d,   z), isoY(x+w,   y+d,   z)],
    [isoX(x,     y+d,   z), isoY(x,     y+d,   z)]
  ];
  const cx = (top[0][0]+top[1][0]+top[2][0]+top[3][0])/4;
  const cy = (top[0][1]+top[1][1]+top[2][1]+top[3][1])/4;
  const pts = top.map(([X,Y])=>{
    const vx = X-cx, vy=Y-cy;
    const len = Math.hypot(vx,vy) || 1;
    const k = (len-insetPx)/len;
    return [cx+vx*k, cy+vy*k];
  });
  const p = document.createElementNS('http://www.w3.org/2000/svg','polygon');
  p.setAttribute('points', pts.map(a=>a.join(' ')).join(' '));
  if(fill) p.setAttribute('fill',fill); else p.setAttribute('fill','none');
  if(stroke){ p.setAttribute('stroke',stroke); p.setAttribute('stroke-width','2'); }
  g.appendChild(p);
}

/* ===== 6) BUILD THE ISOMETRIC SCENE ===== */
function addDefs(svg){
  // White stairs background, lines rotated to exactly 30°
  const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
  const pat = document.createElementNS('http://www.w3.org/2000/svg','pattern');
  pat.setAttribute('id','stairsPattern');
  pat.setAttribute('patternUnits','userSpaceOnUse');
  pat.setAttribute('width','8'); pat.setAttribute('height','8');
  pat.setAttribute('patternTransform','rotate(30)');

  const bg = document.createElementNS('http://www.w3.org/2000/svg','rect');
  bg.setAttribute('x','0'); bg.setAttribute('y','0'); bg.setAttribute('width','8'); bg.setAttribute('height','8');
  bg.setAttribute('fill', '#ffffff');
  pat.appendChild(bg);

  const lines = document.createElementNS('http://www.w3.org/2000/svg','path');
  lines.setAttribute('d','M0,0 L0,8 M4,0 L4,8');
  lines.setAttribute('stroke','rgba(0,0,0,0.55)');
  lines.setAttribute('stroke-width','1.4');
  pat.appendChild(lines);

  defs.appendChild(pat);
  svg.appendChild(defs);
}

/* Numbering RIGHT -> LEFT */
function yForUnit(level, subIndex, d, gapY, maxByLevel){
  const max = maxByLevel[level];
  const posFromLeft = max - subIndex;
  return posFromLeft * (d + gapY);
}

function buildSvg(){
  try{
    const svg=document.getElementById('buildingSvg');
    svg.innerHTML='';
    addDefs(svg);

    const scene=document.createElementNS('http://www.w3.org/2000/svg','g');
    scene.setAttribute('id','scene');
    svg.appendChild(scene);

    const W25=64, D25=64;      // 2.5 Zimmer
    const W15=W25, D15=D25/2;  // 1.5 Zimmer
    const H=26;
    const gapY=8;
    const floorGapZ=126;

    const originX=0;
    const maxByLevel={1:7,2:14,3:3};

    DATA.forEach(u=>{
      const status = normalizeStatus(u.status);
      const colors = safeColors(status);
      const is25 = (u.rooms===2.5);
      const w = is25 ? W25 : W15;
      const d = is25 ? D25 : D15;

      const z=(u.level-1)*(H + floorGapZ);
      const sub = parseInt(u.id.split('.')[1],10);
      const y = yForUnit(u.level, sub, d, gapY, maxByLevel);
      const x = originX;

      const block=makeIsoBlock(x,y,z,w,d,H,colors,u.id);
      scene.appendChild(block);

      /* FLOOR 1 — 2.5er */
      if(u.level===1 && is25){
        const bw=35, bh=4, segGap=4; const segD=(d-segGap)/2;
        const outline=()=>({top:'none',front:'none',side:'none'});

        const left1  = makeIsoPrismRaw(x-bw-1, y,            z, bw, segD, bh, outline(), 'balcony', u.id);
        const left2  = makeIsoPrismRaw(x-bw-1, y+segD+segGap,z, bw, segD, bh, colors,   'balcony', u.id);

        let right1Colors = colors;                 // default: rear upper filled
        let right2Colors = outline();              // default: rear lower outline
        let right1Extra=null, right2Extra=null;

        if(u.id==="1.2"){
          right1Colors = {top:STAIRS_FILL,front:STAIRS_FILL,side:STAIRS_FILL};
          right2Colors = {top:FILL_DARK15,front:FILL_DARK15,side:FILL_DARK15};
          right2Extra  = (g)=>addInsetOnTop(g, x+w+1, y+segD+segGap, z, bw, segD, 6, 'rgba(255,255,255,0.65)', 'rgba(0,0,0,0.45)');
        }
        if(u.id==="1.7"){
          right2Colors = {top:STAIRS_FILL,front:STAIRS_FILL,side:STAIRS_FILL};
        }

        const right1 = makeIsoPrismRaw(x+w+1, y,            z, bw, segD, bh, right1Colors, 'balcony', u.id);
        const right2 = makeIsoPrismRaw(x+w+1, y+segD+segGap,z, bw, segD, bh, right2Colors, 'balcony', u.id);
        if(right1Extra) right1Extra(right1);
        if(right2Extra) right2Extra(right2);

        [left1,left2,right1,right2].forEach(p=>scene.insertBefore(p, block));
      }

      /* FLOOR 2 — alternating by numeric index + overrides */
      if(u.level===2){
        const [frontBalcony, rearBalcony] = addFullLengthBalconies(x,y,z,w,d,status,u.id);
        const n=sub;
        const keepRear  = (n % 2 === 1); // 2.1 rear, 2.3 rear, ...
        const keepFront = (n % 2 === 0); // 2.2 front, 2.4 front, ...

        if(u.id === "2.14" || u.id === "2.2"){
          const bw=35, bh=4;
          const rearStairs = makeIsoPrismRaw(x+w+1, y, z, bw, d, bh,
            {top:STAIRS_FILL,front:STAIRS_FILL,side:STAIRS_FILL}, 'balcony', u.id);
          scene.insertBefore(rearStairs, block);
        } else if(u.id === "2.3"){
          const bw=35, bh=4;
          const rearLift = makeIsoPrismRaw(x+w+1, y, z, bw, d, bh,
            {top:FILL_DARK15,front:FILL_DARK15,side:FILL_DARK15}, 'balcony', u.id);
          addInsetOnTop(rearLift, x+w+1, y, z, bw, d, 8, 'rgba(255,255,255,0.65)', 'rgba(0,0,0,0.45)');
          scene.insertBefore(rearLift, block);
        } else {
          if(keepFront) scene.insertBefore(frontBalcony, block);
          if(keepRear)  scene.insertBefore(rearBalcony,  block);
        }
      }

      /* FLOOR 3 — 2.5er with 3.2 special */
      if(u.level===3 && is25){
        const bw=35, bh=4, segGap=4; const segD=(d-segGap)/2;
        if(u.id==="3.2"){
          const rearLeft  = makeIsoPrismRaw(x+w+1, y,            z, bw, segD, bh,
            {top:STAIRS_FILL,front:STAIRS_FILL,side:STAIRS_FILL}, 'balcony', u.id);
          const rearRight = makeIsoPrismRaw(x+w+1, y+segD+segGap,z, bw, segD, bh,
            {top:FILL_DARK15,front:FILL_DARK15,side:FILL_DARK15}, 'balcony', u.id);
          addInsetOnTop(rearRight, x+w+1, y+segD+segGap, z, bw, segD, 6, 'rgba(255,255,255,0.65)', 'rgba(0,0,0,0.45)');
          scene.insertBefore(rearLeft,  block);
          scene.insertBefore(rearRight, block);

          const left2 = makeIsoPrismRaw(x-bw-1, y+segD+segGap, z, bw, segD, bh, colors, 'balcony', u.id);
          scene.insertBefore(left2, block);
        }else{
          const left2 = makeIsoPrismRaw(x-bw-1, y+segD+segGap, z, bw, segD, bh, colors, 'balcony', u.id);
          const right1= makeIsoPrismRaw(x+w+1,  y,           z, bw, segD, bh, colors, 'balcony', u.id);
          [left2,right1].forEach(p=>scene.insertBefore(p, block));
        }
      }
    });

    // Fit to viewBox safely
    const vb=svg.viewBox.baseVal; const margin=40;
    const sceneNode=document.getElementById('scene');
    const bbox=sceneNode.getBBox();
    if(bbox.width>0 && bbox.height>0){
      const scale=Math.min((vb.width-2*margin)/bbox.width, (vb.height-2*margin)/bbox.height);
      const tx=(vb.width - bbox.width*scale)/2 - bbox.x*scale;
      const ty=(vb.height - bbox.height*scale)/2 - bbox.y*scale;
      sceneNode.setAttribute('transform',`translate(${tx},${ty}) scale(${scale})`);
    } else {
      sceneNode.setAttribute('transform',''); // nothing drawn – avoid NaN transform
    }
  }catch(err){
    console.error('Build SVG failed:', err);
  }
}

/* ===== 7) INTERACTIVITY (SVG ↔ Table) ===== */
function setSvgInteractivity(){
  const svg=document.getElementById('buildingSvg');
  svg.querySelectorAll('[data-unit]').forEach(el=>{
    const id=el.getAttribute('data-unit');
    el.style.cursor='pointer';
    el.addEventListener('mouseenter',()=>highlight(id,true));
    el.addEventListener('mouseleave',()=>highlight(id,false));
    el.addEventListener('click',()=>openFactsheet(id));
  });
}
function highlight(id,on){
  document.querySelectorAll(`#buildingSvg [data-unit="${id}"]`).forEach(el=>{
    if(on) el.classList.add('highlight'); else el.classList.remove('highlight');
  });
  document.querySelectorAll(`#tbody tr`).forEach(tr=>{
    if(tr.getAttribute('data-unit')===id){
      if(on) tr.classList.add('row-highlight'); else tr.classList.remove('row-highlight');
    }
  });
}
function openFactsheet(id){
  const unit = DATA.find(d=>d.id===id);
  if(unit){
    const tr=document.querySelector(`#tbody tr[data-unit="${id}"]`);
    if(tr){ tr.scrollIntoView({behavior:'smooth', block:'center'}); tr.classList.add('row-flash'); setTimeout(()=>tr.classList.remove('row-flash'), 1200); }
    if(unit.factsheet){ window.open(unit.factsheet,'_blank','noopener'); }
  }
}

/* ===== 8) INIT ===== */
function init(){
  applyFilters();
  buildSvg();
  setSvgInteractivity();
  syncStatusesFromSheet();
}
document.addEventListener('DOMContentLoaded', init);

document.getElementById('floorSel').addEventListener('change',()=>{applyFilters(); buildSvg(); setSvgInteractivity();});
document.getElementById('statusSel').addEventListener('change',()=>{applyFilters(); buildSvg(); setSvgInteractivity();});
document.getElementById('roomsSel').addEventListener('change',()=>{applyFilters(); buildSvg(); setSvgInteractivity();});
</script>
</body>
</html>
