<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wohnungsübersicht - Am Zug</title>
<style>
body{margin:0;font-family:sans-serif;background:#eef4f8;color:#233441}
.wrap{max-width:1400px;margin:22px auto;padding:12px}
.panel{background:#fff;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.08);padding:18px 22px}
.controls{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
.field label{display:block;font-size:12px;color:#6b7b86;margin-bottom:4px}
select{width:100%;padding:6px 8px;border-radius:6px;border:1px solid #d7d7dd}
.grid{display:grid;grid-template-columns:1fr 2fr;gap:18px;align-items:start}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
th,td{padding:8px 10px;font-size:14px;border-bottom:1px solid #e0e6eb;text-align:left}
thead{background:#2d3f4d;color:#fff}
.map-container{background:#fff;border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:center;height:100%}
.map-container svg{width:100%;height:100%}
.legend{display:flex;gap:14px;justify-content:flex-end;margin-top:10px;font-size:13px;color:#6b7b86}
.legend .sq{width:12px;height:12px;border-radius:2px}
.sq.ok{background:#5BBE7C}.sq.warn{background:#f5b942}.sq.no{background:#f17575}
.dot{display:inline-block;width:10px;height:10px;border-radius:50%}
.dot.available{background:#5BBE7C}.dot.reserved{background:#f5b942}.dot.rented{background:#f17575}
.unit-block{transition:filter .18s ease, transform .18s ease; cursor:pointer}
.unit-block.highlight{filter:saturate(1.8) brightness(1.06); transform:translateY(-2px)}
.row-highlight{background:#fff7d6 !important; box-shadow: inset 0 0 2px #f5b94240}
.balcony polygon{
  stroke:rgba(0,0,0,0.1); 
  stroke-width:2;
}
.balcony.highlight polygon{filter:saturate(1.8) brightness(1.06)}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <h1>Wohnungen</h1>
    <div class="controls">
      <div class="field"><label>Etage</label><select id="floorSel"></select></div>
      <div class="field"><label>Status</label><select id="statusSel"></select></div>
      <div class="field"><label>Zimmer</label><select id="roomSel"></select></div>
    </div>
    <div class="grid">
      <table id="unitsTable">
        <thead><tr><th>Nr.</th><th>Zimmer</th><th>Etage</th><th>m²</th><th>Status</th><th>Factsheet</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="map-container">
        <svg id="buildingSvg" viewBox="0 0 800 500"></svg>
      </div>
    </div>
    <div class="legend">
      <span><span class="sq ok"></span> Verfügbar</span>
      <span><span class="sq warn"></span> Reserviert</span>
      <span><span class="sq no"></span> Vermietet</span>
    </div>
  </div>
</div>
<script>
/* === DATA === */
const DATA=[];
for(let i=1;i<=7;i++){DATA.push({id:`1.${i}`,rooms:2.5,level:1,m2:56,status:"available"});}
for(let i=1;i<=14;i++){DATA.push({id:`2.${i}`,rooms:1.5,level:2,m2:32.3,status:"available"});}
for(let i=1;i<=3;i++){DATA.push({id:`3.${i}`,rooms:2.5,level:3,m2:56,status:"available"});}

/* === Sync from Google Sheet === */
const STATUS_CSV = "https://docs.google.com/spreadsheets/d/1-oeqRNM-CxGaILY7FNWaNMgC9ccBWDZDwU5l0Eic0pk/export?format=csv&gid=0";
function parseCsv(text){
  const lines=text.trim().split(/\r?\n/);
  const header=lines[0].toLowerCase().split(",");
  const rows=lines.slice(1);
  return rows.map(r=>{
    const cols=r.split(",").map(s=>s.trim());
    const obj={};
    header.forEach((h,i)=>obj[h]=cols[i]);
    return obj;
  });
}
async function syncStatusesFromSheet(){
  try{
    const res=await fetch(STATUS_CSV,{cache:"no-store"});
    const txt=await res.text();
    const rows=parseCsv(txt);
    const byId=new Map(DATA.map(d=>[d.id,d]));
    rows.forEach(r=>{
      if(byId.has(r.id)){
        let d=byId.get(r.id);
        if(r.status) d.status=r.status.toLowerCase();
        if(r.factsheet) d.factsheet=r.factsheet;
      }
    });
    applyFilters(); buildSvg();
  }catch(e){console.warn("Status sync failed:",e);}
}

/* === Rendering === */
function renderTable(list){
  const tb=document.querySelector("#unitsTable tbody");
  tb.innerHTML="";
  list.forEach(d=>{
    const tr=document.createElement("tr");
    tr.dataset.unit=d.id;
    tr.innerHTML=`<td>${d.id}</td><td>${d.rooms}</td><td>${d.level}</td><td>${d.m2}</td>
      <td><span class="dot ${d.status}"></span></td>
      <td>${d.factsheet?`<a href="${d.factsheet}" target="_blank">PDF</a>`:""}</td>`;
    tr.addEventListener("mouseenter",()=>highlight(d.id,true));
    tr.addEventListener("mouseleave",()=>highlight(d.id,false));
    tb.appendChild(tr);
  });
}
function buildSvg(){
  const svg=document.querySelector("#buildingSvg");
  svg.innerHTML="";
  DATA.forEach((d,i)=>{
    const g=document.createElementNS("http://www.w3.org/2000/svg","g");
    g.classList.add("unit-block");
    g.dataset.unit=d.id;
    g.innerHTML=`<rect x="${50+(i%7)*100}" y="${50+(d.level-1)*120}" width="80" height="60" 
      fill="${d.status==="available"?"#c8e6c9":d.status==="reserved"?"#ffe082":"#ef9a9a"}" />`;
    svg.appendChild(g);
  });
}
function highlight(id,on){
  document.querySelectorAll(`[data-unit="${id}"]`).forEach(el=>{
    if(on) el.classList.add("highlight"); else el.classList.remove("highlight");
  });
  document.querySelectorAll(`#unitsTable tbody tr`).forEach(tr=>{
    if(tr.dataset.unit===id){ if(on) tr.classList.add("row-highlight"); else tr.classList.remove("row-highlight"); }
  });
}
function applyFilters(){
  const floor=document.querySelector("#floorSel").value;
  const status=document.querySelector("#statusSel").value;
  const rooms=document.querySelector("#roomSel").value;
  let list=DATA.filter(d=>
    (floor==="all"||d.level==floor)&&
    (status==="all"||d.status===status)&&
    (rooms==="all"||d.rooms==rooms)
  );
  renderTable(list);
}

/* === Setup filters === */
function initFilters(){
  const floors=[...new Set(DATA.map(d=>d.level))];
  const selF=document.querySelector("#floorSel");
  selF.innerHTML="<option value='all'>Alle</option>"+floors.map(f=>`<option value='${f}'>${f}</option>`).join("");
  const selS=document.querySelector("#statusSel");
  selS.innerHTML="<option value='all'>Alle</option><option value='available'>Verfügbar</option><option value='reserved'>Reserviert</option><option value='rented'>Vermietet</option>";
  const rooms=[...new Set(DATA.map(d=>d.rooms))];
  const selR=document.querySelector("#roomSel");
  selR.innerHTML="<option value='all'>Alle</option>"+rooms.map(r=>`<option value='${r}'>${r}</option>`).join("");
  [selF,selS,selR].forEach(sel=>sel.addEventListener("change",applyFilters));
}

initFilters();
applyFilters();
buildSvg();
syncStatusesFromSheet();
</script>
</body>
</html>
