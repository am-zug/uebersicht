<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wohnungen Am Zug</title>
  <style>
    body{margin:0;font-family:sans-serif;background:#ffffff;color:#233441}
    .wrap{max-width:1400px;margin:22px auto;padding:12px}
    .panel{background:#f1f3f5;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.08);padding:18px 22px}
    .controls{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
    .field label{display:block;font-size:12px;color:#6b7b86;margin-bottom:4px}
    select{width:100%;padding:6px 8px;border-radius:6px;border:1px solid #cfd7dd}
    .grid{display:grid;grid-template-columns:1fr 2fr;gap:18px;align-items:start}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
    thead{background:#d2bd76;color:#000}          /* header color per request */
    th,td{padding:8px 10px;font-size:14px;border-bottom:1px solid #e0e6eb;text-align:left}
    tr:hover, tr.active{background:#f8fbfd}
    .map-container{background:#fff;border-radius:12px;border:1px solid #dfe6eb;padding:10px;display:flex;align-items:center;justify-content:center;height:100%}
    svg{width:100%;height:100%}
    .legend{display:flex;gap:14px;justify-content:flex-end;margin-top:10px;font-size:13px;color:#6b7b86}
    .legend .sq{width:12px;height:12px;border-radius:2px}
    .sq.ok{background:#5BBE7C}.sq.warn{background:#F5B942}.sq.no{background:#E17575}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%}
    .dot.available{background:#5BBE7C}
    .dot.reserved{background:#F5B942}
    .dot.rented{background:#E17575}

    .unit-block{transition:filter .18s ease, transform .18s ease; cursor:pointer}
    .unit-block.highlight{filter:saturate(1.8) brightness(1.06); transform:translateY(-2px)}
    .row-highlight{background:#fff7d6 !important; box-shadow:inset 0 0 0 2px #f5b94240}
    .row-flash{animation:flash 1.2s ease}
    @keyframes flash{0%{background:#fff3c4} 100%{background:transparent}}

    /* Keep subtle outlines on ALL balconies */
    .balcony polygon{stroke:rgba(0,0,0,0.1); stroke-width:2}
    .balcony.highlight polygon{filter:saturate(1.8) brightness(1.06)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <h1>Wohnungen Am Zug</h1>
    <div class="controls">
      <div class="field"><label>Etage</label><select id="floorSel"></select></div>
      <div class="field"><label>Status</label><select id="statusSel">
        <option value="all">Alle</option>
        <option value="available">Verfügbar</option>
        <option value="reserved">Reserviert</option>
        <option value="rented">Vermietet</option>
      </select></div>
      <div class="field"><label>Zimmer</label><select id="roomsSel"></select></div>
    </div>
    <div class="grid">
      <div>
        <table>
          <thead>
            <tr>
              <th>Nr.</th>
              <th>Zimmer</th>
              <th>Etage</th>
              <th>m²</th>
              <th>Status</th>
              <th>Factsheet</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div>
        <div class="map-container">
          <svg id="buildingSvg" viewBox="0 0 1600 900"></svg>
        </div>
        <div class="legend"><span class="sq ok"></span> Verfügbar <span class="sq warn"></span> Reserviert <span class="sq no"></span> Vermietet</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== 1) BASE DATA (fallback) ===== */
const DATA=[];
for(let i=1;i<=7;i++){DATA.push({id:`1.${i}`,rooms:2.5,level:1,m2:56,status:(i%3===0?"reserved":"available")});}
for(let i=1;i<=14;i++){DATA.push({id:`2.${i}`,rooms:1.5,level:2,m2:32.3,status:(i%5===0?"rented":"available")});}
for(let i=1;i<=3;i++){DATA.push({id:`3.${i}`,rooms:2.5,level:3,m2:56,status:"available"});}

/* Factsheet fallback by room type */
const DEFAULT_FACTSHEET = {
  "2.5": "https://am-zug.ch/wp-content/uploads/2024/11/2.5-zimmer-wohnung-1.pdf",
  "1.5": "https://am-zug.ch/wp-content/uploads/2024/11/1.5-zimmer-wohnung.pdf"
};

/* ===== 2) GOOGLE SHEET SYNC (status + factsheet; MERGED into DATA) ===== */
const STATUS_CSV = "https://docs.google.com/spreadsheets/d/1-oeqRNM-CxGaILY7FNWaNMgC9ccBWDZDwU5l0Eic0pk/export?format=csv&gid=0";

function parseStatusCsv(text){
  const lines = text.trim().split(/\r?\n/);
  if(!lines.length) return [];
  const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
  const rows = lines.slice(1).filter(Boolean);
  return rows.map(r => {
    const vals = r.split(',').map(s => (s||'').trim());
    const obj = {};
    headers.forEach((h,i)=> obj[h] = vals[i] || "");
    return { id: obj.id, status: (obj.status||'').toLowerCase(), factsheet: obj.factsheet||"" };
  });
}

async function syncStatusesFromSheet(){
  try{
    const res = await fetch(STATUS_CSV, { cache: 'no-store' });
    const txt = await res.text();
    const rows = parseStatusCsv(txt);

    const byId = new Map(DATA.map(d => [d.id, d]));
    rows.forEach(({id, status, factsheet}) => {
      const unit = byId.get(id);
      if(unit){
        if(status) unit.status = status;
        unit.factsheet = factsheet || DEFAULT_FACTSHEET[String(unit.rooms)];
      }
    });
    // Ensure fallbacks for any not in sheet
    DATA.forEach(u=>{ if(!u.factsheet) u.factsheet = DEFAULT_FACTSHEET[String(u.rooms)] || ""; });

    applyFilters();
    buildSvg();
    setSvgInteractivity();
  }catch(e){
    console.warn('Status sync failed:', e);
  }
}

/* ===== 3) COLORS ===== */
const statusColors={
  available:{top:'#dff2e7',front:'#cce6d6',side:'#c2dfcf'},
  reserved:{top:'#fff3db',front:'#f0e1bf',side:'#e8d7ad'},
  rented:{top:'#f9e0e0',front:'#eac9c9',side:'#e2bcbc'}
};

/* ===== 4) TABLE & FILTERS ===== */
function renderTable(list){
  const tbody=document.getElementById('tbody');
  tbody.innerHTML=list.map(d=>`
    <tr data-unit="${d.id}">
      <td>${d.id}</td>
      <td>${d.rooms}</td>
      <td>${d.level}</td>
      <td>${d.m2}</td>
      <td><span class='dot ${d.status}' title='${d.status}'></span></td>
      <td>${d.factsheet ? `<a href="${d.factsheet}" target="_blank" rel="noopener">Factsheet</a>` : '–'}</td>
    </tr>`).join('');

  tbody.querySelectorAll('tr').forEach(tr=>{
    const id=tr.getAttribute('data-unit');
    tr.addEventListener('mouseenter',()=>highlight(id,true));
    tr.addEventListener('mouseleave',()=>highlight(id,false));
    tr.addEventListener('click',()=>openFactsheet(id));
  });
}

function applyFilters(){
  const fFloor=document.getElementById('floorSel').value;
  const fStatus=document.getElementById('statusSel').value;
  const fRooms=document.getElementById('roomsSel').value;
  const list=DATA.filter(d=>(fFloor==='all'||d.level==fFloor)&&(fStatus==='all'||d.status===fStatus)&&(fRooms==='all'||d.rooms==fRooms));
  renderTable(list);
}

/* Dropdowns */
const floorSel=document.getElementById('floorSel');
const roomsSel=document.getElementById('roomsSel');
const floors=[...new Set(DATA.map(d=>d.level))];
const rooms=[...new Set(DATA.map(d=>d.rooms))];
floorSel.innerHTML='<option value="all">Alle</option>'+floors.map(f=>`<option value="${f}">${f}</option>`).join('');
roomsSel.innerHTML='<option value="all">Alle</option>'+rooms.map(r=>`<option value="${r}">${r}</option>`).join('');
document.getElementById('floorSel').addEventListener('change',()=>{applyFilters(); buildSvg(); setSvgInteractivity();});
document.getElementById('statusSel').addEventListener('change',()=>{applyFilters(); buildSvg(); setSvgInteractivity();});
document.getElementById('roomsSel').addEventListener('change',()=>{applyFilters(); buildSvg(); setSvgInteractivity();});

/* ===== 5) ISOMETRIC PROJECTION ===== */
const COS=Math.cos(Math.PI/6);
const SIN=Math.sin(Math.PI/6);
function isoX(x,y,z){return (x + y)*COS;}
function isoY(x,y,z){return (y - x)*SIN - z;}

function makeIsoBlock(x,y,z,w,d,h,colors,unitId){
  const g=document.createElementNS('http://www.w3.org/2000/svg','g');
  g.setAttribute('class','unit-block');
  if(unitId) g.setAttribute('data-unit',unitId);
  const top=`${isoX(x,y,z)} ${isoY(x,y,z)} ${isoX(x+w,y,z)} ${isoY(x+w,y,z)} ${isoX(x+w,y+d,z)} ${isoY(x+w,y+d,z)} ${isoX(x,y+d,z)} ${isoY(x,y+d,z)}`;
  const pTop=document.createElementNS('http://www.w3.org/2000/svg','polygon'); pTop.setAttribute('points',top); pTop.setAttribute('fill',colors.top);
  const front=`${isoX(x,y,z)} ${isoY(x,y,z)} ${isoX(x+w,y,z)} ${isoY(x+w,y,z)} ${isoX(x+w,y,z+h)} ${isoY(x+w,y,z+h)} ${isoX(x,y,z+h)} ${isoY(x,y,z+h)}`;
  const pFront=document.createElementNS('http://www.w3.org/2000/svg','polygon'); pFront.setAttribute('points',front); pFront.setAttribute('fill',colors.front);
  const side=`${isoX(x+w,y,z)} ${isoY(x+w,y,z)} ${isoX(x+w,y+d,z)} ${isoY(x+w,y+d,z)} ${isoX(x+w,y+d,z+h)} ${isoY(x+w,y+d,z+h)} ${isoX(x+w,y,z+h)} ${isoY(x+w,y,z+h)}`;
  const pSide=document.createElementNS('http://www.w3.org/2000/svg','polygon'); pSide.setAttribute('points',side); pSide.setAttribute('fill',colors.side);
  g.appendChild(pTop); g.appendChild(pFront); g.appendChild(pSide);
  return g;
}

function makeIsoPrismRaw(x,y,z,w,d,h,colors, cssClass, unitId){
  const g=document.createElementNS('http://www.w3.org/2000/svg','g');
  if(cssClass) g.setAttribute('class',cssClass);
  if(unitId) g.setAttribute('data-unit',unitId);
  const topPts=`${isoX(x,y,z)} ${isoY(x,y,z)} ${isoX(x+w,y,z)} ${isoY(x+w,y,z)} ${isoX(x+w,y+d,z)} ${isoY(x+w,y+d,z)} ${isoX(x,y+d,z)} ${isoY(x,y+d,z)}`;
  const fPts=`${isoX(x,y,z)} ${isoY(x,y,z)} ${isoX(x+w,y,z)} ${isoY(x+w,y,z)} ${isoX(x+w,y,z+h)} ${isoY(x+w,y,z+h)} ${isoX(x,y,z+h)} ${isoY(x,y,z+h)}`;
  const sPts=`${isoX(x+w,y,z)} ${isoY(x+w,y,z)} ${isoX(x+w,y+d,z)} ${isoY(x+w,y+d,z)} ${isoX(x+w,y+d,z+h)} ${isoY(x+w,y+d,z+h)} ${isoX(x+w,y,z+h)} ${isoY(x+w,y,z+h)}`;
  const pTop=document.createElementNS('http://www.w3.org/2000/svg','polygon'); pTop.setAttribute('points',topPts);
  const pFront=document.createElementNS('http://www.w3.org/2000/svg','polygon'); pFront.setAttribute('points',fPts);
  const pSide=document.createElementNS('http://www.w3.org/2000/svg','polygon'); pSide.setAttribute('points',sPts);
  [pTop,pFront,pSide].forEach((p,i)=>{
    const key=i===0?'top':(i===1?'front':'side');
    const fill=colors[key];
    if(fill && fill!=='none'){ p.setAttribute('fill',fill); } else { p.setAttribute('fill','none'); }
  });
  g.appendChild(pTop); g.appendChild(pFront); g.appendChild(pSide);
  return g;
}

/* Balconies helpers */
function addFullLengthBalconies(x,y,z,w,d,status,unitId){
  const bw=35, bh=4;
  const colors=statusColors[status];
  const leftFull  = makeIsoPrismRaw(x-bw-1, y, z, bw, d, bh, colors, 'balcony', unitId); // LEFT = “front” side (as before)
  const rightFull = makeIsoPrismRaw(x+w+1, y, z, bw, d, bh, colors, 'balcony', unitId); // RIGHT = “rear” side
  return [leftFull, rightFull];
}

/* ===== 6) BUILD THE ISOMETRIC SCENE ===== */
function buildSvg(){
  const svg=document.getElementById('buildingSvg');
  svg.innerHTML='';
  const scene=document.createElementNS('http://www.w3.org/2000/svg','g');
  scene.setAttribute('id','scene');
  svg.appendChild(scene);

  const W25=64, D25=64;      // 2.5 Zimmer
  const W15=W25, D15=D25/2;  // 1.5 Zimmer
  const H=26;
  const gapY=8;
  const floorGapZ=126;

  const originX=0, originY=0;

  [1,2,3].forEach(level=>{
    const units=DATA.filter(d=>d.level===level);
    const x=originX;
    const z=(level-1)*(H + floorGapZ);
    let y=originY;
    let seqIndex=0;

    units.forEach(u=>{
      const is25 = (u.rooms===2.5);
      const w = is25 ? W25 : W15;
      const d = is25 ? D25 : D15;

      const block=makeIsoBlock(x,y,z,w,d,H,statusColors[u.status],u.id);
      scene.appendChild(block);

      if(level===1 && is25){
        // Build split balconies explicitly, so we can drop the "rear" for 1.2.
        const bw=35, bh=4, gap=4; const segD=(d-gap)/2;
        const colors=statusColors[u.status];
        const outline=()=>({top:'none',front:'none',side:'none'});
        const left1 = makeIsoPrismRaw(x-bw-1, y, z, bw, segD, bh, outline(), 'balcony', u.id);
        const left2 = makeIsoPrismRaw(x-bw-1, y+segD+gap, z, bw, segD, bh, colors,   'balcony', u.id);
        const right1= makeIsoPrismRaw(x+w+1,  y, z, bw, segD, bh, colors,   'balcony', u.id); // REAR (filled half)
        const right2= makeIsoPrismRaw(x+w+1,  y+segD+gap, z, bw, segD, bh, outline(), 'balcony', u.id);
        // For 1.2 remove REAR (right side)
        const dropRear = (u.id === "1.2");
        [left1,left2].forEach(p=>scene.insertBefore(p, block));
        if(!dropRear){ [right1,right2].forEach(p=>scene.insertBefore(p, block)); }
      }

      if(level===2){
        // Alternation must START with REAR (right) at 2.1
        const [frontBalcony, rearBalcony] = addFullLengthBalconies(x,y,z,w,d,u.status,u.id);
        // seqIndex: 0 -> 2.1 -> REAR; 1 -> 2.2 -> FRONT; 2 -> 2.3 -> REAR; ...
        const keepFront = (seqIndex % 2 === 1);
        const keepRear  = (seqIndex % 2 === 0);

        // Special: 2.3 should have NO balcony at all
        if(u.id === "2.3"){
          // do nothing (skip both)
        }else{
          if(keepFront){ scene.insertBefore(frontBalcony, block); }
          if(keepRear){  scene.insertBefore(rearBalcony,  block); }
        }
      }

      if(level===3 && is25){
        // Like before: only the two filled halves (rear filled + front filled halves)
        const bw=35, bh=4, gap=4; const segD=(d-gap)/2;
        const colors=statusColors[u.status];
        const left2 = makeIsoPrismRaw(x-bw-1, y+segD+gap, z, bw, segD, bh, colors, 'balcony', u.id);
        const right1= makeIsoPrismRaw(x+w+1,  y, z,           bw, segD, bh, colors, 'balcony', u.id);
        [left2,right1].forEach(p=>scene.insertBefore(p, block));
      }

      y += d + gapY;
      seqIndex++;
    });
  });

  // Fit to viewBox
  const vb=svg.viewBox.baseVal; const margin=40;
  const bbox=document.getElementById('scene').getBBox();
  const scale=Math.min((vb.width-2*margin)/bbox.width, (vb.height-2*margin)/bbox.height);
  const tx=(vb.width - bbox.width*scale)/2 - bbox.x*scale;
  const ty=(vb.height - bbox.height*scale)/2 - bbox.y*scale;
  document.getElementById('scene').setAttribute('transform',`translate(${tx},${ty}) scale(${scale})`);
}

/* ===== 7) INTERACTIVITY (SVG ↔ Table) ===== */
function setSvgInteractivity(){
  const svg=document.getElementById('buildingSvg');
  svg.querySelectorAll('[data-unit]').forEach(el=>{
    const id=el.getAttribute('data-unit');
    el.style.cursor = 'pointer';
    el.addEventListener('mouseenter',()=>highlight(id,true));
    el.addEventListener('mouseleave',()=>highlight(id,false));
    el.addEventListener('click',()=>openFactsheet(id));
  });
}

function highlight(id,on){
  document.querySelectorAll(`#buildingSvg [data-unit="${id}"]`).forEach(el=>{
    if(on) el.classList.add('highlight'); else el.classList.remove('highlight');
  });
  document.querySelectorAll(`#tbody tr`).forEach(tr=>{
    if(tr.getAttribute('data-unit')===id){
      if(on) tr.classList.add('row-highlight'); else tr.classList.remove('row-highlight');
    }
  });
}

function openFactsheet(id){
  const unit = DATA.find(d=>d.id===id);
  if(unit){
    const tr = document.querySelector(`#tbody tr[data-unit="${id}"]`);
    if(tr){ tr.scrollIntoView({behavior:'smooth', block:'center'}); tr.classList.add('row-flash'); setTimeout(()=>tr.classList.remove('row-flash'), 1200); }
    if(unit.factsheet){ window.open(unit.factsheet,'_blank','noopener'); }
  }
}

/* ===== 8) INITIAL RENDER + SHEET SYNC ===== */
applyFilters();
buildSvg();
setSvgInteractivity();
syncStatusesFromSheet();
</script>
</body>
</html>
